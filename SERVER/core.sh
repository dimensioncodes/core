#!/bin/sh

echo //////////////////////////////////////////////////////////////////////////////
echo                        WELCOME IN DIMENSION CODES
echo //////////////////////////////////////////////////////////////////////////////
while :
do

echo //////////////////////////////////////////////////////////////////////////////
read -p "WEBSITE NAME: " app_name
read -p "EXPOSE #$app_name# TO PORT: " app_port
read -p "USERNAME FOR #$app_name#: " app_user
read -p "PASSWORD FOR#$app_user#: " app_pass
echo //////////////////////////////////////////////////////////////////////////////

echo //////////////////////////////////////////////////////////////////////////////
AppName=$app_name
AppPort=$app_port
AppUser=$app_user
AppPass=$app_pass
echo //////////////////////////////////////////////////////////////////////////////

echo //////////////////////////////////////////////////////////////////////////////
mkdir $AppName
cd $AppName
wait
echo //////////////////////////////////////////////////////////////////////////////

echo //////////////////////////////////////////////////////////////////////////////
env=".env-sample"
cat <<EOF > $env
DB_HOST=localhost
DB_USER=$AppUser
DB_PASSWORD=$AppPass
EOF
echo //////////////////////////////////////////////////////////////////////////////

wait

echo //////////////////////////////////////////////////////////////////////////////
compose=docker-compose.yml
cat <<EOF > $compose
version: '3.0'
services:
   wordpress:
      image: wordpress:latest
      container_name: $AppName
      links: 
      - mariadb:mysql
      environment:
      - WORDPRESS_DB_PASSWORD= ${AppPass}
      ports:
      - "$AppPort:$AppPort"
      volumes:
      - "./html_$AppName:/var/www/html"
      restart: always

   mariadb:
      image: mariadb:latest
      container_name: db_$AppName
      environment:
      - MYSQL_ROOT_PASSWORD= ${AppPass}
      - MYSQL_DATABASE_0= wordpress_$AppName
      ports:
      - "3306:3306"
      volumes:
      - ./database_$AppName:/var/lib/mysql
      restart: always 
EOF
echo //////////////////////////////////////////////////////////////////////////////

echo //////////////////////////////////////////////////////////////////////////////
echo DimensionCloud run "$AppName" --public --cloud --port $AppPort --env-file .env-sample
wait
docker compose --env-file .env-sample up -d
cd ..
echo //////////////////////////////////////////////////////////////////////////////
done